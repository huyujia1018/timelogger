# timelogger
a electric project for sophomore students:大二电子技术实践结课设计
电子技术实践结课报告

摘要：电子时钟主要是利用电子技术将时钟电子化、数字化，拥有时钟精确、体积小、界面友好、可扩展性能强等特点，被广泛应用于生活和工作当中。本设计主要为实现一款具有万年历功能、时钟功能、带有定时闹铃、具有跑表功能的的多功能电子时钟。本设计应用EP4CE115F29C7芯片作为核心，7位数码管显示跑表和闹钟，LCD屏显示时间和日期，整点报时用led提示。

1.研究计划要点及执行情况概述
1.1 重点内容
本次实验基本功能的核心在于时钟和日历各个单位之间的进位关系，调整方式以及数据的动态显示。
扩展功能的核心在于闹钟设定时间和整点报时时间与当前时间的比较判断以及闹钟、跑表的独立性。
1.2执行情况
7月8日
基本功能：时间显示、时间调整、日历显示和调整
扩展功能：跑表的部分模块
存在问题：动态显示存在bug,日历没有分平闰年和不同天数的月份
7月9日
基本功能：修复以上bug，日历优化
扩展功能：完成跑表功能，闹钟部分模块，整点报时功能
存在问题：闹钟模块归属问题，即和时钟模块放在一起，还是另外引出子模块；响铃部分尚未实现
7月10日
基本功能：完成全部基本功能
扩展功能：基本完成预计扩展内容
存在问题：响铃部分尝试多种方案均未完成

7月11日
基本功能：全部完成，将可分离的模块分离优化
扩展功能：除响铃尚未实现，其他均已完成
存在问题：有待进一步优化代码结构以及响铃功能

二、研究工作主要进展和所取得的研究成果
2.1 需求分析

2.1.1 基础功能
日历和时钟：能够将时间显示在LCD屏幕上，且随时间动态变化；时、分、秒、星期、年、月、日独节校准，由按键控制；日历要求有平闰年，大小月之分，且纪年跨度足够大。
2.1.2 拓展功能
闹钟：能够准点触发响铃，且持续一段时间，定时调节由滑动开关控制，在数码管上显示时间，响铃的同时要能够在led灯上显示，以示提醒。
跑表：以秒为单位计时，由滑动开关控制开始和停止。
整点报时：准时触发，持续响铃一小段时间，期间led灯亮以示提醒。

2.2 原理说明

2.3 实验方法
用原理图连接和verilog语言编程，形成多个子模块，子模块在顶层文件例化并逻辑连接，最后在FPGA开发板上物理实现。

2.4 系统框图
本次设计的整体框图如下图所示：
 
图1. 系统整体框图
模块说明：
Key_pulse：输出按键脉冲
disp：日历时间及LCD显示
Buzzer_module：整点报时
Alarm_module：闹钟
Stopwatch_module：跑表
输入口说明：
Key1-4：key0-3
rst：SW0
SW1：SW1
SW2：SW2
SW3：SW3
RST_CLK1：SW16
RST_CLK2：SW17
2.5 模块设计
根据需求分析，我们将整个工程分成了timelogger.v顶层文件，以及stopwatch_module，disp，Buzzer_module和key_pulse等四个子模块v文件。
其中timelogger.v顶层文件中实例化各个子模块并定义整个工程的输入输出；stopwatch_module中实现跑表附加功能 ，Buzzer_module中实现整点报时功能，key_pulse中实现按键防抖，disp中实现时间的内核逻辑以及用LCD显示时间，另外为了方便闹钟和时钟的数据对比，我们将闹钟模块的代码也放在了disp里面。
各个模块通过各自的数据接口在顶层模块timelogger中和其他模块相连接，从而构成完整的timerlogger工程。

三、研究人员的合作与分工

整体功能设计，命名规范由小组全员共同完成。
胡宇佳：对于设计思路的整合、整点报时的实现
陈爽：LCD显示，debug工作
杨婧靓：跑表，模块划分
张肖凌：debug工作，各种指导资料的查找
小组全员共同完成时钟内核的实现，各个模块的debug工作小组成员都有参与。

四、总结与展望
4.1 总结与反思
1.我们的第一代完成版代码虽然能完成预期的功能，但是在代码的可读性上存在一定缺陷。为了方便不同功能模块之间的数据交互，我们选择了在disp这个module中写入了大部分功能的代码，而没有将各个功能写在不同的v文件中。这样导致disp.v文件中的代码有七百多行，虽然在开发过程中做好了注释工作，但是代码可读性仍然不高。这样做是用牺牲代码的可读性为代价，从而省去为各个功能模块做接口的工作，在很大程度上规避了一些在模块与模块的衔接层次的bug。
我们在工程完成之后进行反思，认为将一个文件写得过于冗长是一个不好的编程习惯，最好的方式是将每个功能模块单独写一个v文件，这样可以使得代码清楚明了。于是在最后一天我们把disp文件进行了模块化细分，各个模块之间用接口连接，大大提高了代码可读性，使代码变得更加漂亮。
2.在代码书写过程中经常会遇到一些不起眼但是很关键的问题，比如中文输入法输入的符号不能被编译，文件路径中不能有中文，数据类型wire和reg声明，逗号“，”分号“；”的使用等等。这些问题虽然是小问题，但是对于一个熟练的编程人员是不应该的错误，以后应该努力不再出现这种低级错误。
在提高代码可读性方面，合理运用缩进来使代码层次清楚也极其重要。实际编写代码的过程中我们就几次遇到由于没有运用好缩进，使得错误判断了代码层次，导致少写一个end等错误的出现。
3.在目前已完成的代码基础上我们设想再修改一些功能。由于DE2-115开发板上没有蜂鸣器，所以目前整点报时和闹钟响铃都是用LED的点亮来代替，在最后一天我们尝试在DE2-115开发板上接耳机，通过耳机输出音乐来实现整点报时和闹钟响铃的声音，但是在研究了半天之后还是没能写出相应代码，最后只能放弃。
4.前面所展示的代码是我们所做的第二代数字钟，第一代数字钟做好了LCD显示之后连接时钟内核的时候发现时钟内核存在逻辑问题，但是我们检查不出来，无奈之下只能换了一个LCD显示方法并重新编写了时钟内核，顺利完成了预期目标。
4.2 展望
Timelogger的基本功能和进阶功能——整点报时、闹钟和跑表功能已经基本实现，美中不足是整点报时和闹钟功能还未实现通过外设播放提示音频。关于这个功能，我们的设计框架已经完成，就是fpga发送控制字和预存数据给WM8731芯片，芯片把音频解码后输出音频信号到外设接口，相关状态的跳转和信号的输出用Verilog1语言编程控制。
3.附件目录及附件
 
提交的压缩文件包应包含：
1.	结题报告；
2.	注释版代码；
3.	演示视频；
答辩ppt；
4.	给下一年级的建议。

